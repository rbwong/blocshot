{% load static %}
{% load staticfiles %}

<!DOCTYPE html>
<html>
  <head>
    <title>Engineering Survival Guide</title>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- css -->
    <link href="{% static "css/bootstrap.min.css" %}" rel="stylesheet" media="screen">
    <link href="{% static "css/style.css" %}" rel="stylesheet" media="screen">
    <link href="{% static "color/default.css" %}" rel="stylesheet" media="screen">
    <script src="{% static "js/modernizr.custom.js" %}"></script>
    <script type="text/javascript">
      function FacebookFangate(params) {
    var self = this;

    /**
     * Use as last status
     * @type boolean
     */
    self.likes = false;

    /**
     * Debug message
     * @param message
     */
    self.debug = function(message, object) {
        if (typeof(params.debug) != "undefined")
            console.log(message, object);
    };

    // check for FB instance and use it if needed
    self.fbInstance = (typeof params.fbInstance == "object") ? params.fbInstance : null;

    if (self.fbInstance == null) {
        if (typeof(FB) == "undefined")
            throw new Error("Facebook library is not initialized");
        else
            self.fbInstance = FB;
    }

    // set facebook object id we will check for like
    if (typeof (params.fbPageId) == "undefined")
        throw new Error("fbPageId parameter was not passed");

    self.fbPageId = params.fbPageId;

    // set callback function handler
    if (typeof (params.onChangeStatus) != "function")
        throw new Error("onChangeStatus parameter must be function");

    self.onChangeStatus = params.onChangeStatus;

    /**
     * Check whenever is logged user liking the page
     */
    self.checkLike = function() {
        self.debug("checking for like", self.fbPageId);

        // do this check using FQL
        var fqlQuery = "SELECT uid FROM page_fan WHERE page_id = " + self.fbPageId + "and uid = me()";
        var query = self.fbInstance.Data.query(fqlQuery);

        query.wait(function(rows) {
            // query was run, user is liking page if there is row found
            var isLiking = rows.length > 0;

            // call callback status update
            if (self.likes !== isLiking)
                self.onChangeStatus(isLiking);
            self.likes = isLiking;
        }, function(error) {
            // failed, the only error I can think of is login status problem
            if (self.likes !== false)
                self.onChangeStatus(false);
            self.likes = false;
        });
    }

    /**
     * Check for permission
     * @param callback
     */
    self.hasPermission = function(permission, callback) {
        // check for user_likes permission
        var fqlQuery = "SELECT " + permission + " FROM permissions WHERE uid = me()";
        var query = self.fbInstance.Data.query(fqlQuery);

        query.wait(function(rows) {
            // there is something wrong with the results
            if (rows.length == 0) {
                self.debug("Permission SQL returned no rows", rows);
                return;
            }

            // return
            callback(rows[0][permission] == "1");
        });
    };

    /**
     * Listen on user login
     */
    self.fbInstance.Event.subscribe('auth.authResponseChange', function(response) {
        self.debug(response, "auth.login");

        if (typeof(response.status) != "undefined" && response.status == "connected") {
            // check for user_likes permission
            self.hasPermission("user_likes", function(has) {
                // only check for likes if user has this permission
                if (has)
                    self.checkLike();
            });
        }
    });

    /**
     * Listen on like event
     */
    self.fbInstance.Event.subscribe('edge.create', function(href, widget) {
        self.debug(href, "edge.create");
        self.checkLike();
    });

    /**
     * Listen on unlike event
     */
    self.fbInstance.Event.subscribe('edge.remove', function(href, widget) {
        self.debug(href, "edge.remove");
        self.checkLike();
    });

    // call initial check
    self.checkLike();
};
    </script>
      </head>
  <body>
      <div id="fb-root"></div>
      <script>
          window.fbAsyncInit = function() {
              FB.init({
                  appId      : '632923070139972', // enter your facebook app here
                  channelUrl : document.location.protocol + "//" + document.location.host + '/channel.html',
                  status     : true,
                  xfbml      : true
              });

              new FacebookFangate({
                  fbPageId       : '246205298818540', // page we want to use for fan gate
                  onChangeStatus : function(like) {
                      if (like) {
                          document.getElementById("like-wrong").style.display = 'none';
                          document.getElementById("like-ok").style.display = 'block';
                      }
                      else {
                          document.getElementById("like-wrong").style.display = 'block';
                          document.getElementById("like-ok").style.display = 'none';
                      }
                  }
              });
          };

          // Load the SDK asynchronously
          (function(d, s, id){
              var js, fjs = d.getElementsByTagName(s)[0];
              if (d.getElementById(id)) {return;}
              js = d.createElement(s); js.id = id;
              js.src = "//connect.facebook.net/en_US/all.js";
              fjs.parentNode.insertBefore(js, fjs);
          }(document, 'script', 'facebook-jssdk'));
      </script>

      <div>
          <button onclick="FB.login(function(response) {},{scope:'user_likes'});">Login with Facebook</button>
      </div>

      <!-- like buttons -->
      <div class="fb-like-box" data-href="https://www.facebook.com/flwapp" data-width="300" data-height="100" data-colorscheme="light" data-show-faces="true" data-header="true" data-stream="false" data-show-border="true"></div>

      <!-- gate handler -->
      <div id="like-wrong">
          Please login and like page to continue!
      </div>
      <div id="like-ok" style="display:none">
          <!-- About -->
          <section id="about" class="home-section bg-white">
            <div class="container">
                  <div class="row">
                      <div class="col-md-offset-2 col-md-8">
                        <div class="section-heading">
                         <h2>Engineering Survival Guide</h2>
                         <p></p>
                         {% if messages %}
                            <ul class="messages">
                                {% for message in messages %}
                                    <div class="alert alert-success" role="alert">{{ message }}</div>
                                {% endfor %}
                            </ul>
                        {% endif %}
                        </div>
                      </div>
                  </div>
                  <div class="row">
                    <img src="{% static "img/cover.jpg" %}"></img>
              </div>
          </section>

         <!-- Contact -->
          <section id="contact" class="home-section bg-white">
            <div class="container">
                  <div class="row">
                      <div class="col-md-offset-2 col-md-8">
                        <div class="section-heading">
                         <h2>Grab a copy now!</h2>
                         <p>Contact via form below and we will be get in touch with you.</p>
                        </div>
                      </div>
                  </div>

                <div class="row">
                    <div class="col-md-offset-1 col-md-10">
                    <form action="/" method="post" class="form-horizontal" role="form">
                      {% csrf_token %}
                      <div class="form-group">
                        <div class="col-md-offset-2 col-md-8">
                          <input type="text" class="form-control" id="inputName" placeholder="Name" name="name">
                          {% if form.name.errors %}
                                <div class="alert alert-danger" role="alert">{{ form.name.errors }}</div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="form-group">
                        <div class="col-md-offset-2 col-md-8">
                          <input type="text" class="form-control" id="inputEmail" placeholder="Phone no." name="phone_no">
                          {% if form.phone_no.errors %}
                                <div class="alert alert-danger" role="alert">{{ form.phone_no.errors }}</div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="form-group">
                        <div class="col-md-offset-2 col-md-8">
                          <input type="text" class="form-control" id="inputSubject" placeholder="Bloc: ex. G-22" name="bloc">
                          {% if form.bloc.errors %}
                                <div class="alert alert-danger" role="alert">{{ form.bloc.errors }}</div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="form-group">
                        <div class="col-md-offset-2 col-md-8">
                          <input type="text" class="form-control" id="inputSubject" placeholder="facebook url: ex. www.facebook.com/juandelacruz" name="facebook">
                          {% if form.facebook.errors %}
                                <div class="alert alert-danger" role="alert">{{ form.facebook.errors }}</div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="form-group">
                        <div class="col-md-offset-2 col-md-8">
                         <button type="submit" class="btn btn-theme btn-lg btn-block">Submit Form</button>
                        </div>
                      </div>
                    </form>

                    </div>
                </div>
            </div>
          </section>

        <!-- spacer 2 -->
        <section id="spacer" class="home-section spacer">
           <div class="container">
                <div class="row">
                    <div class="col-md-12">
                        <div class="color-light">
                        <h2 class="wow bounceInDown" data-wow-delay="1s">Brought to you by</h2>
                        <img src="{% static "img/seal.png" %}" style="width: 250px; height: auto;"></img>
                        </div>
                    </div>
                </div>
            </div>
        </section>
      </div>

     <!-- js -->
    <script src="{% static "js/jquery.js" %}"></script>
    <script src="{% static "js/bootstrap.min.js" %}"></script>
    <script src="{% static "js/jquery.smooth-scroll.min.js" %}"></script>
    <script src="{% static "js/jquery.dlmenu.js" %}"></script>
    <script src="{% static "js/wow.min.js" %}"></script>
    <script src="{% static "js/custom.js" %}"></script>
    <script type="text/javascript">
      $(document).ready(function(){

        FB.login(function(response) {
          if (response.session) {

              var user_id = response.session.uid;
              var page_id = "632923070139972"; //coca cola
              var fql_query = "SELECT uid FROM page_fan WHERE page_id = "+page_id+"and uid="+user_id;
              var the_query = FB.Data.query(fql_query);

              the_query.wait(function(rows) {

                  if (rows.length == 1 && rows[0].uid == user_id) {
                      alert('yeah!');
                      //here you could also do some ajax and get the content for a "liker" instead of simply showing a hidden div in the page.

                  } else {
                      alert('boo!');
                      //and here you could get the content for a non liker in ajax...
                  }
              });


          } else {
            // user is not logged in
          }
        });

    });
    </script>

</html>
